(function(c){c.fn.markItUp=function(n,f){var b,h,i,r;h=i=r=!1;b={id:"",nameSpace:"",root:"",previewInWindow:"",previewAutoRefresh:!0,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParser:!1,previewParserPath:"",previewParserVar:"data",resizeHandle:!0,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};c.extend(b,n,f);b.root||c("script").each(function(h,i){miuScript=c(i).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);
if(miuScript!==null)b.root=miuScript[1]});return this.each(function(){function f(a,c){return c?a.replace(/("|')~\//g,"$1"+b.root):a.replace(/^~\//,b.root)}function n(a){var j=c("<ul></ul>"),b=0;c("li:hover > ul",j).css("display","block");c.each(a,function(){var a=this,d="",g,h;g=a.key?(a.name||"")+" [Ctrl+"+a.key+"]":a.name||"";key=a.key?'accesskey="'+a.key+'"':"";if(a.separator)d=c('<li class="markItUpSeparator">'+(a.separator||"")+"</li>").appendTo(j);else{b++;for(h=t.length-1;h>=0;h--)d+=t[h]+
"-";d=c('<li class="markItUpButton markItUpButton'+d+b+" "+(a.className||"")+'"><a href="" '+key+' title="'+g+'">'+(a.name||"")+"</a></li>").bind("contextmenu",function(){return!1}).click(function(){return!1}).bind("focusin",function(){e.focus()}).mouseup(function(){a.call&&eval(a.call)();setTimeout(function(){s(a)},1);return!1}).hover(function(){c("> ul",this).show();c(document).one("click",function(){c("ul ul",v).hide()})},function(){c("> ul",this).hide()}).appendTo(j);a.dropMenu&&(t.push(b),c(d).addClass("markItUpDropMenu").append(n(a.dropMenu)))}});
t.pop();return j}function F(a){return a?(a=a.toString(),a=a.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(a,c){var b=c.split("|!|");return r===!0?b[1]!==void 0?b[1]:b[0]:b[1]===void 0?"":b[0]}),a=a.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(a,c){var b=c.split(":!:");if(u===!0)return!1;value=prompt(b[0],b[1]?b[1]:"");value===null&&(u=!0);return value})):""}function l(a){c.isFunction(a)&&(a=a(p));return F(a)}function w(){var a=l(m.openWith),b=l(m.placeHolder),d=l(m.replaceWith),e=l(m.closeWith),g=l(m.openBlockWith),
h=l(m.closeBlockWith);if(d!=="")block=a+d+e;else if(selection===""&&b!=="")block=a+b+e;else{for(var f=selection.split(/\r?\n/),i=[],k=0;k<f.length;k++)line=f[k],c.trim(line)!=""&&(line.match(/ +$/)?i.push(a+line.replace(/ $/,"")+e+" "):i.push(a+line+e));block=i.join("\n")}block=g+block+h;return{block:block,openWith:a,replaceWith:d,placeHolder:b,closeWith:e}}function s(a){var j,f,o;p=m=a;x();c.extend(p,{line:"",root:b.root,textarea:d,selection:selection||"",caretPosition:g,ctrlKey:h,shiftKey:i,altKey:r});
l(b.beforeInsert);l(m.beforeInsert);(h===!0&&i===!0||a.multiline===!0)&&l(m.beforeMultiInsert);c.extend(p,{line:1});if(h===!0&&i===!0){lines=selection.split(/\r?\n/);j=0;f=lines.length;for(o=0;o<f;o++)c.trim(lines[o])!==""?(c.extend(p,{line:++j,selection:lines[o]}),lines[o]=w(lines[o]).block):lines[o]="";string={block:lines.join("\n")};start=g;j=string.block.length+(c.browser.opera?f-1:0)}else h===!0?(string=w(selection),start=g+string.openWith.length,j=string.block.length-string.openWith.length-
string.closeWith.length,j-=string.block.match(/ $/)?1:0,j-=z(string.block)):i===!0?(string=w(selection),start=g,j=string.block.length,j-=z(string.block)):(string=w(selection),start=g+string.block.length,j=0,start-=z(string.block));if(selection===""&&string.replaceWith==="")k+=B(string.block),start=g+string.openWith.length,j=string.block.length-string.openWith.length-string.closeWith.length,k=e.val().substring(g,e.val().length).length,k-=B(e.val().substring(0,g));c.extend(p,{caretPosition:g,scrollPosition:y});
string.block!==selection&&u===!1?(f=string.block,document.selection?document.selection.createRange().text=f:d.value=d.value.substring(0,g)+f+d.value.substring(g+selection.length,d.value.length),C(start,j)):k=-1;x();c.extend(p,{line:"",selection:selection});(h===!0&&i===!0||a.multiline===!0)&&l(m.afterMultiInsert);l(m.afterInsert);l(b.afterInsert);q&&b.previewAutoRefresh&&G();i=r=h=u=!1}function B(a){return c.browser.opera?a.length-a.replace(/\n*/g,"").length:0}function z(a){return c.browser.msie?
a.length-a.replace(/\r*/g,"").length:0}function C(a,b){if(d.createTextRange){if(c.browser.opera&&c.browser.version>=9.5&&b==0)return!1;range=d.createTextRange();range.collapse(!0);range.moveStart("character",a);range.moveEnd("character",b);range.select()}else d.setSelectionRange&&d.setSelectionRange(a,a+b);d.scrollTop=y;d.focus()}function x(){d.focus();y=d.scrollTop;if(document.selection)if(selection=document.selection.createRange().text,c.browser.msie){var a=document.selection.createRange(),b=a.duplicate();
b.moveToElementText(d);for(g=-1;b.inRange(a);)b.moveStart("character"),g++}else g=d.selectionStart;else g=d.selectionStart,selection=d.value.substring(g,d.selectionEnd);return selection}function G(){if(b.previewParser&&typeof b.previewParser==="function"){var a=b.previewParser(e.val());A(f(a,1))}else b.previewParserPath!==""?c.ajax({type:"POST",dataType:"text",global:!1,url:b.previewParserPath,data:b.previewParserVar+"="+encodeURIComponent(e.val()),success:function(a){A(f(a,1))}}):H||c.ajax({url:b.previewTemplatePath,
dataType:"text",global:!1,success:function(a){A(f(a,1).replace(/<\!-- content --\>/g,e.val()))}});return!1}function A(a){if(q.document){try{sp=q.document.documentElement.scrollTop}catch(b){sp=0}q.document.open();q.document.write(a);q.document.close();q.document.documentElement.scrollTop=sp}}function D(a){i=a.shiftKey;r=a.altKey;h=!a.altKey||!a.ctrlKey?a.ctrlKey||a.metaKey:!1;if(a.type==="keydown"){if(h===!0&&(li=c('a[accesskey="'+String.fromCharCode(a.keyCode)+'"]',v).parent("li"),li.length!==0))return h=
!1,setTimeout(function(){li.triggerHandler("mouseup")},1),!1;if(a.keyCode===13||a.keyCode===10)return h===!0?(h=!1,s(b.onCtrlEnter),b.onCtrlEnter.keepDefault):i===!0?(i=!1,s(b.onShiftEnter),b.onShiftEnter.keepDefault):(s(b.onEnter),b.onEnter.keepDefault);if(a.keyCode===9)return i==!0||h==!0||r==!0?!1:k!==-1?(x(),k=e.val().length-k,C(k,0),k=-1,!1):(s(b.onTab),b.onTab.keepDefault)}}var e,d,t,y,g,k,m,p,v,E,q,H,u;e=c(this);d=this;t=[];u=!1;y=g=0;k=-1;b.previewParserPath=f(b.previewParserPath);b.previewTemplatePath=
f(b.previewTemplatePath);(function(){nameSpace=id="";b.id?id='id="'+b.id+'"':e.attr("id")&&(id='id="markItUp'+e.attr("id").substr(0,1).toUpperCase()+e.attr("id").substr(1)+'"');b.nameSpace&&(nameSpace='class="'+b.nameSpace+'"');e.wrap("<div "+nameSpace+"></div>");e.wrap("<div "+id+' class="markItUp"></div>');e.wrap('<div class="markItUpContainer"></div>');e.addClass("markItUpEditor");v=c('<div class="markItUpHeader"></div>').insertBefore(e);c(n(b.markupSet)).appendTo(v);E=c('<div class="markItUpFooter"></div>').insertAfter(e);
b.resizeHandle===!0&&c.browser.safari!==!0&&(resizeHandle=c('<div class="markItUpResizeHandle"></div>').insertAfter(e).bind("mousedown",function(a){var b=e.height(),d=a.clientY,f,g;f=function(a){e.css("height",Math.max(20,a.clientY+b-d)+"px");return!1};g=function(){c("html").unbind("mousemove",f).unbind("mouseup",g);return!1};c("html").bind("mousemove",f).bind("mouseup",g)}),E.append(resizeHandle));e.keydown(D).keyup(D);e.bind("insertion",function(a,b){b.target!==!1&&x();d===c.markItUp.focused&&s(b)});
e.focus(function(){c.markItUp.focused=this})})()})};c.fn.markItUpRemove=function(){return this.each(function(){var n=c(this).unbind().removeClass("markItUpEditor");n.parent("div").parent("div.markItUp").parent("div").replaceWith(n)})};c.markItUp=function(n){var f={target:!1};c.extend(f,n);if(f.target)return c(f.target).each(function(){c(this).focus();c(this).trigger("insertion",[f])});else c("textarea").trigger("insertion",[f])}})(jQuery);
